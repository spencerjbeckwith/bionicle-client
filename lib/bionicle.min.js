(function(){'use strict';function x(){r=window.innerWidth<window.innerHeight?window.innerWidth/m.width:window.innerHeight/m.height,r=k(l(r),1),n.width=m.width*r,n.height=m.height*r,o.width=n.width,o.height=n.height,q.imageSmoothingEnabled=!1,q.setTransform(1,0,0,1,0,0),q.scale(r,r)}function y(b,a){var c=Math.min;let d=parseInt(b.slice(0,2),16)/255,g=parseInt(b.slice(2,4),16)/255,i=parseInt(b.slice(4,6),16)/255;return a&&(d=k(0,c(1,d+a)),g=k(0,c(1,g+a)),i=k(0,c(1,i+a))),[d,g,i]}function a(b,a,c,d=.2,e=.2,f=.2){this.primary=[y(b,0),y(b,d),y(b,-d)],this.secondary=[y(a,0),y(a,e),y(a,-f)],this.eye=[y(c,0),y(c,f),y(c,-f)]}function b(d){const a=new D(d.vertex,d.fragment);a.positionAttribute=p.getAttribLocation(a.program,"a_position"),a.textureAttribute=p.getAttribLocation(a.program,"a_texcoord"),a.positionMatrix=p.getUniformLocation(a.program,"u_positionMatrix"),a.textureMatrix=p.getUniformLocation(a.program,"u_texcoordMatrix"),a.blendUniform=p.getUniformLocation(a.program,"u_blend"),a.buffer=p.createBuffer();const b=new Float32Array([0,0,0,1,1,1,1,1,1,0,0,0]);return p.bindBuffer(p.ARRAY_BUFFER,a.buffer),p.bufferData(p.ARRAY_BUFFER,b,p.STATIC_DRAW),p.enableVertexAttribArray(a.positionAttribute),p.vertexAttribPointer(a.positionAttribute,2,p.FLOAT,!1,0,0),p.enableVertexAttribArray(a.textureAttribute),p.vertexAttribPointer(a.textureAttribute,2,p.FLOAT,!1,0,0),a.use=function(){C!==this&&(C=this,p.useProgram(this.program),p.bindBuffer(p.ARRAY_BUFFER,a.buffer),p.bufferData(p.ARRAY_BUFFER,new Float32Array(b),p.STATIC_DRAW),p.vertexAttribPointer(F.positionAttribute,2,p.FLOAT,!1,0,0))},a}async function c(f){return new Promise(function(a,b){const c=p.createTexture();p.bindTexture(p.TEXTURE_2D,c),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,p.NEAREST),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MIN_FILTER,p.NEAREST),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_S,p.CLAMP_TO_EDGE),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_T,p.CLAMP_TO_EDGE);const d=new Image;d.src=f,d.addEventListener("load",function(){p.bindTexture(p.TEXTURE_2D,c),p.texImage2D(p.TEXTURE_2D,0,p.RGBA,p.RGBA,p.UNSIGNED_BYTE,d),a(c)}),d.addEventListener("error",function(c){b(c)})})}function d(b){p.bindFramebuffer(p.FRAMEBUFFER,M),p.viewport(0,0,m.width,m.height),p.clearColor(0,0,0,1),p.clear(p.COLOR_BUFFER_BIT),q.clearRect(0,0,m.width,m.height),q.save(),p.bindTexture(p.TEXTURE_2D,b),H.use(),p.uniform4f(H.blendUniform,1,1,1,1)}function e(){p.bindFramebuffer(p.FRAMEBUFFER,null),p.viewport(0,0,n.width,n.height),p.clearColor(0,0,0,0),p.clear(p.COLOR_BUFFER_BIT),p.bindTexture(p.TEXTURE_2D,I),H.use(),p.bindBuffer(p.ARRAY_BUFFER,H.buffer),p.enableVertexAttribArray(H.positionAttribute),p.vertexAttribPointer(H.positionAttribute,2,p.FLOAT,!1,0,0),p.uniformMatrix3fv(H.positionMatrix,!1,J),p.uniformMatrix3fv(H.textureMatrix,!1,K),p.uniform4fv(H.blendUniform,L),p.drawArrays(p.TRIANGLES,0,6),q.restore()}function Z(c,a){return a=l(a),c.images[a]||(a-=c.images.length),a}function f(h,c,m,e,f,i=1,j=1,a=1,k=1,g=null){G.use(),c=Z(h,c);let b=v.projection;b=v.translation(b,m,e),b=v.scaling(b,h.width,h.height),g&&(b=g(b)),p.uniformMatrix3fv(G.positionMatrix,!1,b),p.uniformMatrix3fv(G.textureMatrix,!1,h.images[c].textureMatrix),p.uniform4f(G.blendUniform,j,a,k,i),G.setPalette(f),p.drawArrays(p.TRIANGLES,0,6)}function g(d,c,a){return d+a*(c-d)}function h(a,h,d,b=.1){var e=Math.abs;return a===h?a:(a=g(a,h,d),e(a-h)<b&&(a=h),a)}function i(){return 15+Math.round(500*Math.random())}function j(){d(X),V.step(),e(),W.reset(),requestAnimationFrame(j)}var k=Math.max,l=Math.floor,m={font:"10px Yusei Magic",width:400,height:240,atlasWidth:2048,atlasHeight:2048};const n=document.createElement("canvas"),o=document.createElement("canvas");document.body.appendChild(n),document.body.appendChild(o),n.width=m.width,n.height=m.height,o.width=m.width,o.height=m.height;const p=n.getContext("webgl",{antialias:!1});if(null===p)throw new Error("Could not initialize WebGL!");const q=o.getContext("2d");q.imageSmoothingEnabled=!1;let r=1;x(),window.addEventListener("resize",x),window.addEventListener("orientationchange",x);var s={vertex:`
attribute vec2 a_position;

uniform mat3 u_positionMatrix;

void main() {
    gl_Position = vec4((u_positionMatrix*vec3(a_position,1)).xy,0,1);
}`,fragment:`
precision mediump float;

uniform vec4 u_color;

void main() {
    gl_FragColor = u_color;
}`},t={vertex:`
// No change from image shader here
attribute vec2 a_position;
attribute vec2 a_texcoord;

uniform mat3 u_positionMatrix;
uniform mat3 u_texcoordMatrix;

varying vec2 v_texcoord;

void main() {
    gl_Position = vec4((u_positionMatrix*vec3(a_position,1)).xy,0,1);
    v_texcoord = (u_texcoordMatrix*vec3(a_texcoord,1.0)).xy;
}`,fragment:`
precision mediump float;
uniform sampler2D u_image;                                  
uniform vec4 u_blend;

// Colors to swap
uniform vec3 u_replacedPrimary;
uniform vec3 u_replacedPrimaryLight;
uniform vec3 u_replacedPrimaryDark;
uniform vec3 u_replacedSecondary;
uniform vec3 u_replacedSecondaryLight;
uniform vec3 u_replacedSecondaryDark;
uniform vec3 u_replacedEye;
uniform vec3 u_replacedEyeLight;
uniform vec3 u_replacedEyeDark;

// What to swap to
uniform vec3 u_primary;
uniform vec3 u_primaryLight;
uniform vec3 u_primaryDark;
uniform vec3 u_secondary;
uniform vec3 u_secondaryLight;
uniform vec3 u_secondaryDark;
uniform vec3 u_eye;
uniform vec3 u_eyeLight;
uniform vec3 u_eyeDark;

varying vec2 v_texcoord;

void main() {
    // Get current frag color from texture
    vec4 color = texture2D(u_image,v_texcoord);

    // If color equals a value to swap...
    if (color.rgb == u_replacedPrimary) {
        // Set it to the new replacement
        color = vec4(u_primary.rgb,color.a);
    } else if (color.rgb == u_replacedPrimaryLight) {
        color = vec4(u_primaryLight.rgb,color.a);
    } else if (color.rgb == u_replacedPrimaryDark) {
        color = vec4(u_primaryDark.rgb,color.a);
    } else if (color.rgb == u_replacedSecondary) {
        color = vec4(u_secondary.rgb,color.a);
    } else if (color.rgb == u_replacedSecondaryLight) {
        color = vec4(u_secondaryLight.rgb,color.a);
    } else if (color.rgb == u_replacedSecondaryDark) {
        color = vec4(u_secondaryDark.rgb,color.a);
    } else if (color.rgb == u_replacedEye) {
        color = vec4(u_eye.rgb,color.a);
    } else if (color.rgb == u_replacedEyeLight) {
        color = vec4(u_eyeLight.rgb,color.a);
    } else if (color.rgb == u_replacedEyeDark) {
        color = vec4(u_eyeDark.rgb,color.a);
    }

    // Blend and set
    gl_FragColor = color*u_blend;
}`};const v={multiply:function(u,c){var a=u[0],b=u[1],d=u[2],e=u[3],f=u[4],g=u[5],h=u[6],i=u[7],j=u[8],k=c[0],l=c[1],m=c[2],n=c[3],o=c[4],p=c[5],q=c[6],r=c[7],s=c[8];return[k*a+l*e+m*h,k*b+l*f+m*i,k*d+l*g+m*j,n*a+o*e+p*h,n*b+o*f+p*i,n*d+o*g+p*j,q*a+r*e+s*h,q*b+r*f+s*i,q*d+r*g+s*j]},translation:function(d,a,b){return v.multiply(d,[1,0,0,0,1,0,a,b,1])},rotation:function(e,a){var b=Math.cos(a),d=Math.sin(a);return v.multiply(e,[b,-d,0,d,b,0,0,0,1])},scaling:function(d,a,b){return v.multiply(d,[a,0,0,0,b,0,0,0,1])},projection:[2/m.width,0,0,0,-2/m.height,0,-1,1,1],identity:[1,0,0,0,1,0,0,0,1]},w={red:"c4281b",darkPink:"c470a0",orange:"da8540",brown:"675237",tan:"d7c599",black:"1b2a34",green:"287f46",darkGray:"6d6e6c",white:"d0d1d0",mediumBlue:"6e99c9",lightGray:"a1a5a2",blue:"0d69ab",yellow:"f5cd2f",lime:"a4bd46",darkOrange:"a05f34",purple:"6b327b",sandBlue:"74869c",darkTurquoise:"008f9b",metallicGold:"dbac34",metallicSilver:"a9a5b4",pearlLightGray:"9ca3a8"},z={primary:"b5b5b5",primaryLight:"e6e6e6",primaryDark:"545454",secondary:"2700ad",secondaryLight:"734cfa",secondaryDark:"12004b",eye:"ae0000",eyeLight:"fb4c4c",eyeDark:"4b0000"},A={tahu:new a(w.red,w.orange,w.darkPink),pohatu:new a(w.brown,w.tan,w.orange),onua:new a(w.black,w.darkGray,w.green),kopaka:new a(w.white,w.lightGray,w.mediumBlue),gali:new a(w.blue,w.mediumBlue,w.yellow),lewa:new a(w.green,w.lime,w.lime),vakama:new a(w.orange,w.red,w.darkPink),onewa:new a(w.tan,w.brown,w.orange),whenua:new a(w.darkGray,w.black,w.green),nuju:new a(w.lightGray,w.white,w.mediumBlue),nokama:new a(w.mediumBlue,w.blue,w.yellow),matau:new a(w.lime,w.green,w.lime)};A.tahu.gold=new a(w.metallicGold,w.orange,w.darkPink,.4),A.tahu.silver=new a(w.metallicSilver,w.orange,w.darkPink,.4),A.pohatu.gold=new a(w.metallicGold,w.tan,w.orange,.4),A.pohatu.silver=new a(w.metallicSilver,w.tan,w.orange,.4),A.onua.gold=new a(w.metallicGold,w.darkGray,w.green,.4),A.onua.silver=new a(w.metallicSilver,w.darkGray,w.green,.4),A.kopaka.gold=new a(w.metallicGold,w.lightGray,w.mediumBlue,.4),A.kopaka.silver=new a(w.metallicSilver,w.lightGray,w.mediumBlue,.4),A.gali.gold=new a(w.metallicGold,w.mediumBlue,w.yellow,.4),A.gali.silver=new a(w.metallicSilver,w.mediumBlue,w.yellow,.4),A.lewa.gold=new a(w.metallicGold,w.lime,w.lime,.4),A.lewa.silver=new a(w.metallicSilver,w.lime,w.lime,.4);const B={primary:[y(z.primary,0),y(z.primaryLight,0),y(z.primaryDark,0)],secondary:[y(z.secondary,0),y(z.secondaryLight,0),y(z.secondaryDark,0)],eye:[y(z.eye,0),y(z.eyeLight,0),y(z.eyeDark,0)]};let C=null;class D{constructor(c,a){this.program=this.createShaderProgram(c,a)}use(){C!==this&&(C=this,p.useProgram(this.program))}createShaderProgram(f,a){const b=this.createShader(p.VERTEX_SHADER,f),c=this.createShader(p.FRAGMENT_SHADER,a),d=p.createProgram();if(p.attachShader(d,b),p.attachShader(d,c),p.linkProgram(d),p.getProgramParameter(d,p.LINK_STATUS))return d;else{const b=p.getProgramInfoLog(d);throw p.deleteProgram(d),new Error(`Could not link shader program: ${b}`)}}createShader(d,a){const b=p.createShader(d);if(p.shaderSource(b,a),p.compileShader(b),p.getShaderParameter(b,p.COMPILE_STATUS))return b;else{const c=p.getShaderInfoLog(b);throw p.deleteShader(b),new Error(`Could not compile shader: ${c}`)}}}const F=function(){const b=new D(s.vertex,s.fragment);return b.positionAttribute=p.getAttribLocation(b.program,"a_position"),b.positionMatrix=p.getUniformLocation(b.program,"u_positionMatrix"),b.colorUniform=p.getUniformLocation(b.program,"u_color"),b.buffer=p.createBuffer(),p.bindBuffer(p.ARRAY_BUFFER,b.buffer),p.bufferData(p.ARRAY_BUFFER,new Float32Array([0,0,.5,.5]),p.DYNAMIC_DRAW),p.enableVertexAttribArray(b.positionAttribute),p.vertexAttribPointer(b.positionAttribute,2,p.FLOAT,!1,0,0),b.use(),p.uniformMatrix3fv(b.positionMatrix,!1,v.projection),b}(),G=function(){const c=b(t);return c.use(),p.uniform3fv(p.getUniformLocation(c.program,"u_replacedPrimary"),B.primary[0]),p.uniform3fv(p.getUniformLocation(c.program,"u_replacedPrimaryLight"),B.primary[1]),p.uniform3fv(p.getUniformLocation(c.program,"u_replacedPrimaryDark"),B.primary[2]),p.uniform3fv(p.getUniformLocation(c.program,"u_replacedSecondary"),B.secondary[0]),p.uniform3fv(p.getUniformLocation(c.program,"u_replacedSecondaryLight"),B.secondary[1]),p.uniform3fv(p.getUniformLocation(c.program,"u_replacedSecondaryDark"),B.secondary[2]),p.uniform3fv(p.getUniformLocation(c.program,"u_replacedEye"),B.eye[0]),p.uniform3fv(p.getUniformLocation(c.program,"u_replacedEyeLight"),B.eye[1]),p.uniform3fv(p.getUniformLocation(c.program,"u_replacedEyeDark"),B.eye[2]),c.uniformPrimary=p.getUniformLocation(c.program,"u_primary"),c.uniformPrimaryLight=p.getUniformLocation(c.program,"u_primaryLight"),c.uniformPrimaryDark=p.getUniformLocation(c.program,"u_primaryDark"),c.uniformSecondary=p.getUniformLocation(c.program,"u_secondary"),c.uniformSecondaryLight=p.getUniformLocation(c.program,"u_secondaryLight"),c.uniformSecondaryDark=p.getUniformLocation(c.program,"u_secondaryDark"),c.uniformEye=p.getUniformLocation(c.program,"u_eye"),c.uniformEyeLight=p.getUniformLocation(c.program,"u_eyeLight"),c.uniformEyeDark=p.getUniformLocation(c.program,"u_eyeDark"),c.setPalette=function(a){p.uniform3fv(c.uniformPrimary,a.primary[0]),p.uniform3fv(c.uniformPrimaryLight,a.primary[1]),p.uniform3fv(c.uniformPrimaryDark,a.primary[2]),p.uniform3fv(c.uniformSecondary,a.secondary[0]),p.uniform3fv(c.uniformSecondaryLight,a.secondary[1]),p.uniform3fv(c.uniformSecondaryDark,a.secondary[2]),p.uniform3fv(c.uniformEye,a.eye[0]),p.uniform3fv(c.uniformEyeLight,a.eye[1]),p.uniform3fv(c.uniformEyeDark,a.eye[2])},c}(),H=b({vertex:`
attribute vec2 a_position;
attribute vec2 a_texcoord;

uniform mat3 u_positionMatrix;
uniform mat3 u_texcoordMatrix;

varying vec2 v_texcoord;

void main() {
    gl_Position = vec4((u_positionMatrix*vec3(a_position,1)).xy,0,1);
    v_texcoord = (u_texcoordMatrix*vec3(a_texcoord,1.0)).xy;
}`,fragment:`
precision mediump float;

uniform sampler2D u_image;
uniform vec4 u_blend;

varying vec2 v_texcoord;

void main() {
    gl_FragColor = texture2D(u_image,v_texcoord)*u_blend;
}`});p.clearColor(0,0,0,1),p.clear(p.COLOR_BUFFER_BIT),p.disable(p.DEPTH_TEST),p.enable(p.BLEND),p.blendFunc(p.SRC_ALPHA,p.ONE_MINUS_SRC_ALPHA);const I=p.createTexture();p.bindTexture(p.TEXTURE_2D,I),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,p.NEAREST),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MIN_FILTER,p.NEAREST),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_S,p.CLAMP_TO_EDGE),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_T,p.CLAMP_TO_EDGE),p.texImage2D(p.TEXTURE_2D,0,p.RGBA,m.width,m.height,0,p.RGBA,p.UNSIGNED_BYTE,null);const J=[2,0,0,0,-2,0,-1,1,1],K=[1,0,0,0,-1,0,0,1,1];let L=[1,1,1,1];const M=p.createFramebuffer();p.bindFramebuffer(p.FRAMEBUFFER,M),p.framebufferTexture2D(p.FRAMEBUFFER,p.COLOR_ATTACHMENT0,p.TEXTURE_2D,I,0);class N{constructor(c,a){this.parent=null,this.children=[],this.x=c,this.y=a,this.sprite=null,this.opened=!1}addChild(){const b=new N;this.children.push(b),b.parent=this}step(){for(const b in this.children)this.children[b].step()}}class O extends N{constructor(c,a){super(c,a)}}class P{constructor(d,a,b){this.name=d,this.palette=a,this.level=1,this.xp=0,this.masks=b,this.currentMask=this.masks[0]||null,this.elements=[],this.status=[],this.hp=10,this.maxhp=10,this.nova=10,this.maxnova=10,this.agility=10,this.strength=10,this.toughness=10,this.mind=10,this.accuracy=10,this.critical=10}}var Q=[{name:"statusbar",width:225,height:64,images:[{x:0,y:0}]},{name:"allyPanel",width:64,height:160,images:[{x:240,y:0}]},{name:"kanohi",width:40,height:48,images:[{x:304,y:0},{x:352,y:0},{x:400,y:0},{x:448,y:0},{x:496,y:0},{x:544,y:0},{x:592,y:0},{x:640,y:0},{x:688,y:0},{x:736,y:0},{x:784,y:0},{x:832,y:0}]},{name:"head",width:40,height:40,images:[{x:880,y:0},{x:928,y:0},{x:976,y:0},{x:1024,y:0}]},{name:"headSecondary",width:40,height:40,images:[{x:1072,y:0},{x:1120,y:0},{x:1168,y:0},{x:1216,y:0}]}];class R{constructor(e,a,b,c){this.name=e,this.width=a,this.height=b,this.images=c;for(let d,g=0;g<this.images.length;g++)d=v.identity,d=v.translation(d,c[g].x/m.atlasWidth,c[g].y/m.atlasHeight),d=v.scaling(d,this.width/m.atlasWidth,this.height/m.atlasHeight),this.images[g].textureMatrix=d}}const S={};for(let c in Q){const a=Q[c];S[a.name]=new R(a.name,a.width,a.height,a.images)}class T extends N{constructor(c,a){super(c,300+c),this.fighter=a,this.ready=!1,this.opened=!1,this.faceImage=0,this.faceSpeed=0,this.blinkTimer=i()}step(){super.step(),this.effectStep(),this.draw()}effectStep(){this.ready||(this.y=h(this.y,158,.12,1),158===this.y&&(this.ready=!0)),this.blinkTimer--,0>=this.blinkTimer&&(this.faceSpeed=.2,this.blinkTimer=i()),0!==this.faceSpeed&&(this.faceImage+=this.faceSpeed,4<=this.faceImage&&(this.faceImage=0,this.faceSpeed=0))}draw(){f(S.allyPanel,0,this.x,this.y,this.fighter.palette),q.textAlign="center",q.textBaseline="top",q.font=m.font,q.fillStyle="white",q.fillText(this.fighter.name,this.x+32,this.y+61,50),f(S.head,this.ready?this.faceImage:2,this.x+12,this.y+12,this.fighter.palette),this.fighter.currentMask&&f(S.kanohi,this.fighter.currentMask.image,this.x+12,this.y+12,this.fighter.palette)}}const U={hau:{name:"Hau",image:0},kakama:{name:"Kakama",image:1},pakari:{name:"Pakari",image:2},akaku:{name:"Akaku",image:3},kaukau:{name:"Kaukau",image:4},miru:{name:"Miru",image:5},huna:{name:"Huna",image:6},komau:{name:"Komau",image:7},ruru:{name:"Ruru",image:8},matatu:{name:"Matatu",image:9},rau:{name:"Rau",image:10},mahiki:{name:"Mahiki",image:11}},V=new function(){this.init=function(){this.active=!1,this.allies=[],this.enemies=[],this.panels={statusbar:null,allyPanels:[],enemyPanels:[]}}.bind(this),this.begin=function(c,a){this.active=!0,this.allies=c,this.enemies=a,this.panels.statusbar=new O(80,0);for(let b=0;b<this.allies.length;b++)this.panels.allyPanels[b]=new T(64*b,this.allies[b])}.bind(this),this.end=function(){this.active=!1,this.init([],[])}.bind(this),this.step=function(){if(this.active)for(const b in this.panels.allyPanels)this.panels.allyPanels[b].step()}.bind(this)};V.init(),V.begin([new P("Tahu",A.tahu,[U.hau]),new P("Gali",A.gali,[U.kaukau]),new P("Lewa",A.lewa,[U.miru]),new P("Pohatu",A.pohatu,[U.kakama]),new P("Onua",A.onua,[U.pakari]),new P("Kopaka",A.kopaka,[U.akaku])]);const W=new function(){this.mb={left:0,middle:1,right:2,back:3,forward:4},this.mouseX=0,this.mouseY=0,this.mousePressed=[,,,,,],this.mouseHeld=[,,,,,],this.mouseReleased=[,,,,,],this.mousePressed.fill(!1),this.mouseHeld.fill(!1),this.mouseReleased.fill(!1),o.addEventListener("mousemove",function(b){this.mouseX=l(b.offsetX/r),this.mouseY=l(b.offsetY/r)}.bind(this)),o.addEventListener("mousedown",function(b){this.mousePressed[b.button]=!0,this.mouseHeld[b.button]=!0}.bind(this)),o.addEventListener("mouseup",function(b){this.mouseReleased[b.button]=!0,this.mouseHeld[b.button]=!1}.bind(this)),o.addEventListener("contextmenu",function(b){b.preventDefault()}),this.mouseWithin=function(e,a,b,c){return!!(this.mouseX>=e&&this.mouseX<b&&this.mouseY>=a&&this.mouseY<c)}.bind(this),this.reset=function(){this.mousePressed.fill(!1),this.mouseReleased.fill(!1)}.bind(this)};let X=null;(async()=>{X=await c("../asset/atlas.png"),j()})()})();